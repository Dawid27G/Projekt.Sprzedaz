---
title: "Raport – Analiza danych Superstore"
author: "Dawid Genert, Agnieszka Ancypo, Sylwia Bech"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 3
    toc_float: true
      
editor_options: 
  markdown: 
    wrap: 72
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)

pkgs <- c(
  "readxl","dplyr","mice","lubridate","tidyr","ggplot2","naniar","plotly",
  "corrplot","Hmisc","ggstatsplot","classInt","kableExtra","psych",
  "ggridges","frequency"
)

miss <- setdiff(pkgs, rownames(installed.packages()))
if (length(miss)) {
  stop(
    "Brakuje pakietów: ", paste(miss, collapse = ", "),
    "\nZainstaluj je poleceniem z README.md"
  )
}

invisible(lapply(pkgs, library, character.only = TRUE))

dane <- read_excel(file.path("data","superstore.xls"), sheet = 1)
dane_disc <- read_excel(file.path("data","superstore.xls"), sheet = 2)

df <- dane %>%
mutate(
  `Order Date` = as.Date(`Order Date`),
  Sales    = as.numeric(Sales),
  Profit   = as.numeric(Profit),
  Quantity = as.numeric(Quantity),
  Discount = as.numeric(Discount),
  Category = as.character(Category),
  Segment  = as.character(Segment)
)
```

# 1. Wprowadzenie

Celem niniejszego projektu jest analiza zbioru danych "Superstore",
zawierającego informacje o transakcjach detalicznych w sieci sklepów.
Zbiór obejmuje dane o sprzedaży, zyskach, kategoriach produktów oraz
lokalizacji klientów na terenie USA.

Główne pytania badawcze:

1.  Jaki wpływ mają rabaty na zysk - czy większy rabat zawsze zwiększa
    sprzedaż kosztem rentowności?

2.  Które kategorie i podkategorie produktów generują najwyższą
    sprzedaż, a które najwyższy zysk?

3.  Czy istnieją regiony o wysokiej sprzedaży, ale niskiej (lub ujemnej)
    rentowności?

4.  Jak zmieniały się sprzedaż i zysk w czasie - czy występuje
    sezonowość?

5.  Które produkty lub podkategorie generują straty i jakie czynniki
    (rabat, region, wysyłka) na to wpływają?

# 2. Data Cleansing & Data Wrangling

Proces przygotowania danych był wieloetapowy, aby zapewnić najwyższą
jakość analizy.

```{r, echo=FALSE, message=FALSE, warning=FALSE}

miss_var_summary(dane)
miss_case_summary(dane)
vis_miss(dane)
gg_miss_var(dane) +
  labs(title = "Liczba braków danych w każdej zmiennej")
gg_miss_case(dane) +
  labs(title = "Braki danych w poszczególnych wierszach")
gg_miss_upset(dane)
miss_var_summary(dane)
```

```{r include=FALSE}

md.pattern(dane)

dane <- dane %>%
  mutate(
    `Order Date` = as.Date(`Order Date`),
    `Ship Date`  = as.Date(`Ship Date`)
  )


hotdeck_grouped <- function(x, group_df) {
  out <- x
  g <- interaction(group_df, drop = TRUE)

  for (lv in levels(g)) {
    idx <- which(g == lv)
    vals <- x[idx]
    miss <- is.na(vals)

    if (any(miss) && any(!miss)) {
      out[idx][miss] <- sample(vals[!miss], sum(miss), replace = TRUE)
    }
  }


  if (any(is.na(out)) && any(!is.na(out))) {
    out[is.na(out)] <- sample(out[!is.na(out)], sum(is.na(out)), replace = TRUE)
  }

  out
}

cat_vars <- c("Ship Mode","Segment","Region","Category","Sub-Category")
cat_vars <- intersect(cat_vars, names(dane))

group_vars <- c("Region","Segment")
group_vars <- intersect(group_vars, names(dane))

set.seed(123)
for (v in cat_vars) {
  dane[[v]] <- hotdeck_grouped(dane[[v]], dane[group_vars])
}


num_vars <- c("Sales","Quantity","Discount","Profit")
num_vars <- intersect(num_vars, names(dane))

num_df <- dane %>% select(all_of(num_vars))

set.seed(123)
imp_num <- mice(
  num_df,
  m = 5,
  method = "pmm",
  maxit = 5,
  printFlag = FALSE
)

num_complete <- complete(imp_num, 1)


dane[num_vars] <- num_complete


if (all(c("Product ID", "Product Name") %in% names(dane))) {
  lookup_prod <- dane %>%
    filter(!is.na(`Product ID`), !is.na(`Product Name`)) %>%
    distinct(`Product ID`, `Product Name`)

  dane <- dane %>%
    left_join(lookup_prod, by = "Product ID", suffix = c("", ".from_id")) %>%
    mutate(`Product Name` = ifelse(is.na(`Product Name`), `Product Name.from_id`, `Product Name`)) %>%
    select(-`Product Name.from_id`)
}


fill_by_key_first <- function(x, key) {

  filled <- ave(x, key, FUN = function(z) {
    if (all(is.na(z))) return(z)
    z[is.na(z)] <- z[which(!is.na(z))[1]]
    z
  })
  filled
}

if ("Postal Code" %in% names(dane)) {
  if ("City" %in% names(dane))  dane$City  <- fill_by_key_first(dane$City,  dane$`Postal Code`)
  if ("State" %in% names(dane)) dane$State <- fill_by_key_first(dane$State, dane$`Postal Code`)
}


if ("City" %in% names(dane) && "State" %in% names(dane)) {
  dane$City <- fill_by_key_first(dane$City, dane$State)
}
if ("State" %in% names(dane) && "Region" %in% names(dane)) {
  dane$State <- fill_by_key_first(dane$State, dane$Region)
}

if (all(c("Order Date","Ship Date","Ship Mode","Region") %in% names(dane))) {
  ship_days <- as.integer(dane$`Ship Date` - dane$`Order Date`)

  grp <- interaction(dane$`Ship Mode`, dane$Region, drop = TRUE)
  med_by_grp <- tapply(ship_days, grp, function(z) median(z, na.rm = TRUE))

  miss_sd <- is.na(dane$`Ship Date`)
  if (any(miss_sd)) {

    global_med <- median(ship_days, na.rm = TRUE)
    fill_days <- med_by_grp[as.character(grp[miss_sd])]
    fill_days[is.na(fill_days)] <- global_med

    dane$`Ship Date`[miss_sd] <- dane$`Order Date`[miss_sd] + as.integer(fill_days)
  }
}

for (nm in names(dane)) {
  if (anyNA(dane[[nm]])) {
    if (is.numeric(dane[[nm]])) {
      dane[[nm]][is.na(dane[[nm]])] <- median(dane[[nm]], na.rm = TRUE)
    } else if (inherits(dane[[nm]], "Date")) {
      dane[[nm]][is.na(dane[[nm]])] <- median(dane[[nm]], na.rm = TRUE)
    } else {

      tab <- table(dane[[nm]])
      moda <- names(tab)[which.max(tab)]
      dane[[nm]][is.na(dane[[nm]])] <- moda
    }
  }
}


stopifnot(sum(is.na(dane)) == 0)

md.pattern(dane)
head(dane)
```

-   **Identyfikacja braków:** Wykryto braki danych w kluczowych
    zmiennych takich jak Discount (20%), Profit (11%) oraz danych
    adresowych.

-   **Imputacja danych numerycznych:** Zastosowano zaawansowany algorytm
    MICE (Multivariate Imputation by Chained Equations) z metodą PMM
    (Predictive Mean Matching). Pozwala to na uzupełnienie braków w
    oparciu o korelacje z innymi zmiennymi, co jest bardziej precyzyjne
    niż użycie średniej.

-   **Hot-deck Imputation:** Dla zmiennych kategorycznych (np. Ship
    Mode) użyto metody hot-deck, losując wartości z istniejącego
    rozkładu wewnątrz grup (Region/Segment).

-   Braki w nazwach miast i stanów uzupełniono na podstawie kodów
    pocztowych (Postal Code), wykorzystując relacje przestrzenne w
    danych.

-   Brakujące daty wysyłki wyliczono na podstawie mediany czasu dostawy
    dla danego trybu wysyłki i regionu.

# 3. Wizualicje danych

```{r, echo = FALSE}
# Sprzedaż i Zysk w czasie (miesięcznie)
m <- df %>%
  mutate(month = floor_date(`Order Date`, "month")) %>%
  group_by(month) %>%
  summarise(
    Sales = sum(Sales, na.rm = TRUE),
    Profit = sum(Profit, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(month)

p1 <- plot_ly(m, x = ~month) %>%
  add_lines(y = ~Sales, name = "Sales") %>%
  add_lines(y = ~Profit, name = "Profit", yaxis = "y2") %>%
  layout(
    title = "Sales & Profit over time (monthly)",
    xaxis = list(title = ""),
    yaxis = list(title = "Sales"),
    yaxis2 = list(title = "Profit", overlaying = "y", side = "right")
  )

p1
```

```{r, echo = FALSE}
# Sprzedaż według Kategorii i Segmentu
agg <- df %>%
  group_by(Category, Segment) %>%
  summarise(Sales = sum(Sales, na.rm = TRUE), .groups = "drop")

p2 <- plot_ly(
  data = agg,
  x = ~Category,
  y = ~Sales,
  color = ~Segment,
  type = "bar"
) %>%
  layout(
    title = "Sales by Category and Segment",
    barmode = "stack",
    yaxis = list(title = "Sales")
  )

p2
```

```{r, echo = FALSE}
# Sprzedaż vs Zysk - wykres punktowy
df_sc <- df %>%
  filter(!is.na(Sales), !is.na(Profit)) %>%
  mutate(Quantity = ifelse(is.na(Quantity), 0, Quantity))

p3 <- plot_ly(
  data = df_sc,
  x = ~Sales,
  y = ~Profit,
  type = "scatter",
  mode = "markers",
  color = ~Category,
  size = ~Quantity,
  sizes = c(6, 45),
  text = ~paste0(
    "Product: ", `Product Name`,
    "<br>Sub-Category: ", `Sub-Category`,
    "<br>State: ", State,
    "<br>Discount: ", Discount
  ),
  hoverinfo = "text"
) %>%
  layout(
    title = "Sales vs Profit",
    xaxis = list(title = "Sales (log)", type = "log"),
    yaxis = list(title = "Profit")
  )

p3
```

```{r, echo = FALSE}
# Mapa cieplna sprzedaży: Kategoria × Region
df <- read_excel("superstore.xls") %>%
  mutate(
    Sales = as.numeric(Sales),
    Region = as.character(Region),
    Category = as.character(Category)
  )

heat <- df %>%
  group_by(Category, Region) %>%
  summarise(Sales = sum(Sales, na.rm = TRUE), .groups = "drop")

plot_ly(
  heat,
  x = ~Region,
  y = ~Category,
  z = ~Sales,
  type = "heatmap",
  colors = "Blues"
) %>%
  layout(title = "Sales heatmap: Category × Region")
```

```{r, echo = FALSE}
# Mapa drzewa: Sprzedaż według Kategorii i Podkategorii
tree <- df %>%
  group_by(Category, `Sub-Category`) %>%
  summarise(Sales = sum(Sales, na.rm = TRUE), .groups = "drop")

plot_ly(
  tree,
  labels = ~`Sub-Category`,
  parents = ~Category,
  values = ~Sales,
  type = "treemap"
) %>%
  layout(title = "Treemap: Sales by Category and Sub-Category")
```

```{r, echo = FALSE}
# Rozkład zysku według Segmentu
plot_ly(
  df,
  x = ~Segment,
  y = ~Profit,
  type = "violin",
  box = list(visible = TRUE),
  meanline = list(visible = TRUE)
) %>%
  layout(
    title = "Profit distribution by Segment",
    yaxis = list(title = "Profit")
  )
```

```{r, echo = FALSE}
# Rozkład rabatów
plot_ly(
  df,
  x = ~Discount,
  type = "histogram",
  nbinsx = 20
) %>%
  layout(
    title = "Distribution of Discount",
    xaxis = list(title = "Discount"),
    yaxis = list(title = "Count")
  )
```

```{r, echo = FALSE}
# Top 10 stanów według zysku
top_states <- df %>%
  group_by(State) %>%
  summarise(Profit = sum(Profit, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(Profit)) %>%
  slice_head(n = 10)

plot_ly(
  top_states,
  x = ~reorder(State, Profit),
  y = ~Profit,
  type = "bar"
) %>%
  layout(
    title = "Top 10 States by Profit",
    xaxis = list(title = "", tickangle = -45),
    yaxis = list(title = "Profit")
  )
```

```{r, echo = FALSE}
# Sprzedaż w czasie według Kategorii (wykres obszarowy)
area <- df %>%
  mutate(month = floor_date(`Order Date`, "month")) %>%
  group_by(month, Category) %>%
  summarise(Sales = sum(Sales, na.rm = TRUE), .groups = "drop")

plot_ly(
  area,
  x = ~month,
  y = ~Sales,
  color = ~Category,
  type = "scatter",
  mode = "none",
  stackgroup = "one"
) %>%
  layout(
    title = "Sales over time by Category",
    yaxis = list(title = "Sales")
  )
```

```{r, echo = FALSE}
# Macierz korelacji
num_df <- df %>%
  select(Discount, Quantity, Sales, Profit) %>%
  mutate(across(everything(), as.numeric)) %>%
  na.omit()

rc <- rcorr(as.matrix(num_df))
R <- rc$r
P <- rc$P
corrplot(
  R,
  type = "lower",
  method = "color",
  addCoef.col = "black",
  number.cex = 0.9,
  tl.col = "black",
  tl.srt = 45
)
n <- ncol(R)

for (i in 2:n) {
  for (j in 1:(i-1)) {
    if (P[i, j] < 0.05) {
      stars <- ifelse(P[i, j] < 0.001, "***",
               ifelse(P[i, j] < 0.01, "**", "*"))

      text(
        x = j,
        y = n - i + 1 + 0.25,  
        labels = stars,
        cex = 1,
        col = "black"
      )
    }
  }
}
```
```{r}
category_stats <- dane %>%
  group_by(Category) %>%
  summarise(
    liczba_zamówień = n(),
    średni_zysk = mean(Profit, na.rm = TRUE),
    suma_sprzedaży = sum(Sales, na.rm = TRUE),
    .groups = "drop"
  )
plot_ly(
  data = category_stats,
  x = ~liczba_zamówień,
  y = ~średni_zysk,
  size = ~suma_sprzedaży,
  color = ~Category,

  sizes = c(30, 80), 
  type = 'scatter',
  mode = 'markers+text',
  text = ~Category,
  textposition = ifelse(category_stats$Category == "Office Supplies", 
                       "middle left",
                ifelse(category_stats$Category == "Technology",
                       "bottom right",
                       "top center")),

  textfont = list(size = 14, color = 'black'),
  
  marker = list(
    opacity = 0.6,
    line = list(width = 0),
    sizemode = 'diameter'
  )
) %>%
  layout(
    xaxis = list(title = "Liczba zamówień", range = c(1500, 6500)),
    yaxis = list(title = "Średni zysk ($)", range = c(-5, 100)), 
    
    template = "plotly_white",
    showlegend = TRUE)
```


```{r}

df$order_date <- as.Date(df$`Order Date`)
df$ship_date <- as.Date(df$`Ship Date`)
df$shipping_days <- as.numeric(df$ship_date - df$order_date)

region_stats <- df %>%
  group_by(Region) %>%
  summarise(
    średni_czas_dostawy = mean(shipping_days, na.rm = TRUE),
    liczba_zamówień = n(),
    średni_zysk = mean(Profit, na.rm = TRUE),
    średnia_sprzedaż = mean(Sales, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(średni_czas_dostawy) # Sortowanie rosnąco

region_stats$Region <- factor(region_stats$Region, levels = region_stats$Region)


plot_ly(
  data = region_stats,
  x = ~Region,
  y = ~średni_czas_dostawy,
  type = 'bar',
  

  marker = list(
    color = ~średni_zysk,
    colorscale = "RdYlGn", 
    colorbar = list(title = "Śr. zysk ($)"),
    line = list(color = 'white', width = 1.5) 
  ),
  

  text = ~paste0(round(średni_czas_dostawy, 1), " dni"),
  textposition = 'outside',
  textfont = list(color = 'black', size = 12, family = "Arial", weight = "bold"),
  

  hoverinfo = "text",
  hovertext = ~paste0(
    "<b>Region:</b> ", Region,
    "<br>Czas dostawy: ", round(średni_czas_dostawy, 2), " dni",
    "<br>Średni zysk: <b>$", round(średni_zysk, 2), "</b>",
    "<br>Liczba zamówień: ", liczba_zamówień
  )
) %>%
  layout(
    title = list(
      text = "<b>Średni czas dostawy wg regionu</b><br><sup>Im niższy słupek = szybsza dostawa | Kolor = średni zysk</sup>",
      x = 0.05
    ),
    xaxis = list(title = "Region"),

    yaxis = list(title = "Średni czas dostawy (dni)", range = c(0, max(region_stats$średni_czas_dostawy) * 1.15)),
    template = "plotly_white"
  )
```


```{r}

polish_days <- c("poniedziałek", "wtorek", "środa", "czwartek", "piątek", "sobota", "niedziela")
df$weekday <- factor(weekdays(df$`Order Date`), levels = polish_days, ordered = TRUE)


weekday_stats <- df %>%
  group_by(weekday) %>%
  summarise(
    liczba_zamówień = n(),
    średnia_wartość_zamówienia = mean(Sales, na.rm = TRUE),
    średni_zysk = mean(Profit, na.rm = TRUE),
    średni_czas_dostawy = mean(shipping_days, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(weekday)


weekday_long <- weekday_stats %>%
  pivot_longer(
    cols = c(liczba_zamówień, średnia_wartość_zamówienia, średni_zysk),
    names_to = "metric",
    values_to = "value_raw"
  ) %>%
  mutate(
    metric = case_when(
      metric == "liczba_zamówień" ~ "Liczba zamówień",
      metric == "średnia_wartość_zamówienia" ~ "Śr. wartość zamówienia ($)",
      metric == "średni_zysk" ~ "Śr. zysk ($)",
      TRUE ~ metric
    ),
    label = ifelse(metric == "Liczba zamówień",
                   as.character(round(value_raw, 0)),
                   paste0("$", round(value_raw, 0)))
  ) %>%
  group_by(metric) %>%
  mutate(
    value_scaled = {
      mn <- min(value_raw, na.rm = TRUE)
      mx <- max(value_raw, na.rm = TRUE)
      if (isTRUE(all.equal(mx, mn))) rep(0.5, n()) else (value_raw - mn) / (mx - mn)
    }
  ) %>%
  ungroup()


x_days <- levels(df$weekday)
y_metrics <- c("Śr. zysk ($)", "Śr. wartość zamówienia ($)", "Liczba zamówień")

weekday_long <- weekday_long %>%
  mutate(
    weekday = factor(weekday, levels = x_days, ordered = TRUE),
    metric  = factor(metric, levels = y_metrics, ordered = TRUE)
  ) %>%
  arrange(metric, weekday)


z <- matrix(NA_real_, nrow = length(y_metrics), ncol = length(x_days),
            dimnames = list(y_metrics, x_days))
text_mat <- matrix("", nrow = length(y_metrics), ncol = length(x_days),
                   dimnames = list(y_metrics, x_days))
raw_mat <- matrix(NA_real_, nrow = length(y_metrics), ncol = length(x_days),
                  dimnames = list(y_metrics, x_days))

for (m in y_metrics) {
  for (d in x_days) {
    tmp <- weekday_long %>% filter(metric == m, weekday == d)
    z[m, d] <- tmp$value_scaled[1]
    text_mat[m, d] <- tmp$label[1]
    raw_mat[m, d] <- tmp$value_raw[1]
  }
}


rdylgn <- list(
  list(0.00, "#ffffbf"),
  list(1.00, "#d73027")
)

plot_ly(
  x = x_days,
  y = y_metrics,
  z = z,
  type = "heatmap",
  zmin = 0, zmax = 1,
  colorscale = rdylgn,
  text = text_mat,
  texttemplate = "%{text}",
  textfont = list(color = "black"),
  customdata = raw_mat,
  hovertemplate = paste(
    "<b>Dzień:</b> %{x}<br>",
    "<b>Metryka:</b> %{y}<br>",
    "<b>Wartość:</b> %{customdata}<br>",
    "<b>Skala (0–1):</b> %{z:.2f}<extra></extra>"
  ),
  colorbar = list(title = "RdYlGn (0–1)")
) %>%
  layout(
    title = list(
      text = "Wydajność dni tygodnia - Heatmap<br><sup>Kolor = wynik znormalizowany (0–1) w obrębie metryki, RdYlGn</sup>"
    ),
    xaxis = list(title = "Dzień tygodnia", tickangle = -45),
    yaxis = list(title = "Metryka"),
    margin = list(l = 110, r = 80, t = 70, b = 80)
  )
```

```{r}
# =========================
# ANALIZA WPŁYWU RABATÓW NA ZYSK (PLOTLY)
# =========================

df <- df %>%
  mutate(
    profit_margin = ifelse(Sales > 0, Profit / Sales * 100, NA_real_),
    discount_group = cut(
      Discount * 100,
      breaks = c(0, 10, 20, 30, 40, 50, 100),
      labels = c("0-10%", "11-20%", "21-30%", "31-40%", "41-50%", ">50%"),
      include.lowest = TRUE
    )
  )

discount_analysis <- df %>%
  group_by(discount_group) %>%
  summarise(
    orders = n(),
    avg_discount = mean(Discount, na.rm = TRUE) * 100,
    avg_sales = mean(Sales, na.rm = TRUE),
    avg_profit = mean(Profit, na.rm = TRUE),
    avg_profit_margin = mean(profit_margin, na.rm = TRUE),
    total_sales = sum(Sales, na.rm = TRUE),
    total_profit = sum(Profit, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(!is.na(discount_group) & orders > 0) %>%
  mutate(
    sales_share = total_sales / sum(total_sales, na.rm = TRUE) * 100,
    profit_share = total_profit / sum(total_profit, na.rm = TRUE) * 100
  ) %>%
  arrange(discount_group)


x_groups <- levels(df$discount_group)
discount_analysis <- discount_analysis %>%
  mutate(discount_group = factor(discount_group, levels = x_groups, ordered = TRUE)) %>%
  arrange(discount_group)


discount_analysis <- discount_analysis %>%
  mutate(
    bar_color = ifelse(avg_profit_margin >= 0, "darkgreen", "red"),
    label_pm  = paste0(round(avg_profit_margin, 1), "%"),
   hover_txt = paste0(
  "<b>Grupa rabatu:</b> ", discount_group,
  "<br><b>Śr. marża:</b> ", sprintf("%.2f", avg_profit_margin), "%",
  "<br><b>Zamówienia:</b> ", orders,
  "<br><b>Śr. rabat:</b> ", sprintf("%.1f", avg_discount), "%",
  "<br><b>Śr. sprzedaż:</b> ", sprintf("%.2f", avg_sales), "$",
  "<br><b>Śr. zysk:</b> ", sprintf("%.2f", avg_profit), "$"
)
  )

p1 <- plot_ly(
  data = discount_analysis,
  x = ~discount_group,
  y = ~avg_profit_margin,
  type = "bar",
  marker = list(color = ~bar_color),
  text = ~label_pm,
  textposition = "outside",
  cliponaxis = FALSE,
  hovertext = ~hover_txt,
  hoverinfo = "text"
) %>%
  layout(
    title = "Średnia marża wg rabatu",
    xaxis = list(title = "Grupa rabatu", tickangle = -30),
    yaxis = list(title = "Marża (%)", zeroline = TRUE, zerolinewidth = 2),
    margin = list(l = 70, r = 30, t = 60, b = 80),
    bargap = 0.25
  )


p2 <- plot_ly(
  data = discount_analysis,
  x = ~discount_group,
  y = ~orders,
  type = "scatter",
  mode = "lines+markers",
  line = list(width = 2),
  hovertemplate = paste(
    "<b>Grupa rabatu:</b> %{x}<br>",
    "<b>Liczba zamówień:</b> %{y}<br>",
    "<b>Śr. rabat:</b> %{customdata:.1f}%<extra></extra>"
  ),
  customdata = ~avg_discount
) %>%
  layout(
    title = "Rabat vs zamówienia",
    xaxis = list(title = "Grupa rabatu"),
    yaxis = list(title = "Liczba zamówień")
  )


p3 <- plot_ly(
  data = discount_analysis,
  x = ~discount_group,
  y = ~profit_share,
  type = "bar",
  hovertemplate = paste(
    "<b>Grupa rabatu:</b> %{x}<br>",
    "<b>Udział w zysku:</b> %{y:.2f}%<br>",
    "<b>Zysk łącznie:</b> %{customdata:.0f}$<extra></extra>"
  ),
  customdata = ~total_profit
) %>%
  layout(
    title = "Udział w zysku",
    xaxis = list(title = "Grupa rabatu"),
    yaxis = list(title = "Udział w zysku (%)")
  )
global_mean_sales <- mean(df$Sales, na.rm = TRUE)

p4 <- plot_ly(
  data = discount_analysis,
  x = ~discount_group,
  y = ~avg_sales,
  type = "scatter",
  mode = "lines+markers",
  line = list(width = 2),
  hovertemplate = paste(
    "<b>Grupa rabatu:</b> %{x}<br>",
    "<b>Śr. wartość zakupu:</b> %{y:.2f}$<br>",
    "<b>Śr. rabat:</b> %{customdata:.1f}%<extra></extra>"
  ),
  customdata = ~avg_discount
) %>%
  layout(
    title = "Rabat vs średnia wartość zakupu",
    xaxis = list(title = "Grupa rabatu"),
    yaxis = list(title = "Śr. wartość zakupu ($)"), 
    shapes = list(
      list(
        type = "line", xref = "paper", x0 = 0, x1 = 1,
        yref = "y", y0 = global_mean_sales, y1 = global_mean_sales,
        line = list(color = "gray", width = 2, dash = "dash")
      )
    ),
    annotations = list(
      list(
        xref = "paper", x = 0.5, y = global_mean_sales,
        text = paste0("Średnia globalna: $", round(global_mean_sales, 2)),
        showarrow = FALSE, yshift = -12, font = list(color = "gray")
      )
    )
  )

p1
p2
p3
p4

```


```{r}
wrap_labels <- function(x, width = 12) stringr::str_wrap(x, width = width)


subcategory_analysis <- df %>%
  group_by(Category, `Sub-Category`) %>%
  summarise(
    total_sales = sum(Sales, na.rm = TRUE),
    total_profit = sum(Profit, na.rm = TRUE),
    avg_profit_margin = mean(Profit / Sales * 100, na.rm = TRUE),
    orders = n(),
    .groups = "drop"
  ) %>%
  filter(total_sales > 0)


top_sales_subcat <- subcategory_analysis %>%
  arrange(desc(total_sales)) %>%
  head(5) %>%
  mutate(
    sales_k = total_sales / 1000,
    hover_txt = paste0(
      "<b>Kategoria:</b> ", Category,
      "<br><b>Podkategoria:</b> ", `Sub-Category`,
      "<br><b>Sprzedaż:</b> ", round(total_sales, 0), "$",
      "<br><b>Zysk:</b> ", round(total_profit, 0), "$",
      "<br><b>Marża:</b> ", round(avg_profit_margin, 2), "%",
      "<br><b>Zamówienia:</b> ", orders
    )
  )

p_sales <- plot_ly(
  data = top_sales_subcat,
  x = ~`Sub-Category`,
  y = ~sales_k,
  type = "bar",
  hovertext = ~hover_txt,
  hoverinfo = "text"
) %>%
  layout(
    xaxis = list(
      title = "",
      tickvals = top_sales_subcat$`Sub-Category`,
      ticktext = wrap_labels(top_sales_subcat$`Sub-Category`, 12)
    ),
    yaxis = list(title = "Sprzedaż (tys. $)"),
    bargap = 0.25
  )


top_profit_subcat <- subcategory_analysis %>%
  arrange(desc(total_profit)) %>%
  head(5) %>%
  mutate(
    profit_k = total_profit / 1000,
    bar_color = ifelse(total_profit < 0, "red", "darkgreen"),
    hover_txt = paste0(
      "<b>Kategoria:</b> ", Category,
      "<br><b>Podkategoria:</b> ", `Sub-Category`,
      "<br><b>Zysk:</b> ", round(total_profit, 0), "$",
      "<br><b>Sprzedaż:</b> ", round(total_sales, 0), "$",
      "<br><b>Marża:</b> ", round(avg_profit_margin, 2), "%",
      "<br><b>Zamówienia:</b> ", orders
    )
  )

p_profit <- plot_ly(
  data = top_profit_subcat,
  x = ~`Sub-Category`,
  y = ~profit_k,
  type = "bar",
  marker = list(color = ~bar_color),
  hovertext = ~hover_txt,
  hoverinfo = "text"
) %>%
  layout(
    xaxis = list(
      title = "",
      tickvals = top_profit_subcat$`Sub-Category`,
      ticktext = wrap_labels(top_profit_subcat$`Sub-Category`, 12)
    ),
    yaxis = list(
      title = "Zysk (tys. $)",
      zeroline = TRUE,
      zerolinewidth = 2
    ),
    bargap = 0.25
  )


p <- plotly::subplot(p_sales, p_profit, shareX = FALSE, titleX = TRUE) %>%
  layout(
    title = list(text = "Top 5 podkategorii – porównanie", x = 0.5),
    showlegend = FALSE,


annotations = list(
  list(
    x = 0.22, y = 1.02, xref = "paper", yref = "paper",
    text = "<b>Sprzedaż</b>",
    showarrow = FALSE,
    font = list(size = 13, color = "#333333")
  ),
  list(
    x = 0.78, y = 1.02, xref = "paper", yref = "paper",
    text = "<b>Zysk</b>",
    showarrow = FALSE,
    font = list(size = 13, color = "#333333")
  )
),


    margin = list(l = 70, r = 30, t = 110, b = 120)
  )


p <- config(p, displayModeBar = FALSE)

p
```


```{r}
# ANALIZA REGIONÓW 
region_summary <- df %>%
  group_by(Region) %>%
  summarise(
    sprzedaż = sum(Sales, na.rm = TRUE) / 1000,
    zysk = sum(Profit, na.rm = TRUE) / 1000,
    marża = mean(Profit / Sales * 100, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(!is.na(marża)) %>%
  mutate(
    kolor = ifelse(marża >= 15, "darkgreen",
                   ifelse(marża >= 10, "orange", "red")),
    hover_txt = paste0(
      "<b>Region:</b> ", Region,
      "<br><b>Sprzedaż:</b> ", round(sprzedaż, 1), " tys. $",
      "<br><b>Zysk:</b> ", round(zysk, 1), " tys. $",
      "<br><b>Marża:</b> ", round(marża, 2), "%"
    )
  )

p1 <- plot_ly(
  data = region_summary,
  x = ~sprzedaż,
  y = ~marża,
  type = "scatter",
  mode = "markers+text",
  marker = list(
    size = ~abs(zysk) * 2,
    color = ~kolor,
    line = list(color = "white", width = 2),
    opacity = 0.7
  ),
  text = ~Region,
  textposition = "top center",
  textfont = list(size = 12, color = "black"),
  hovertext = ~hover_txt,
  hoverinfo = "text"
) %>%
  layout(
    title = "Regiony: Sprzedaż vs Marża",
    xaxis = list(title = "Sprzedaż (tys. $)"),
    yaxis = list(title = "Marża (%)"),
    showlegend = FALSE
  )

p2 <- plot_ly(
  data = region_summary,
  x = ~Region,
  y = ~marża,
  type = "bar",
  marker = list(color = ~kolor),
  text = ~paste0(round(marża, 1), "%"),
  textposition = "outside",
  hovertext = ~hover_txt,
  hoverinfo = "text"
) %>%
  layout(
    title = "Marża wg regionu",
    xaxis = list(title = ""),
    yaxis = list(title = "Marża (%)"),
    shapes = list(
      list(
        type = "line", xref = "paper", x0 = 0, x1 = 1,
        yref = "y", y0 = 15, y1 = 15,
        line = list(color = "green", width = 2, dash = "dash")
      ),
      list(
        type = "line", xref = "paper", x0 = 0, x1 = 1,
        yref = "y", y0 = 10, y1 = 10,
        line = list(color = "orange", width = 2, dash = "dash")
      )
    ),
    showlegend = FALSE
  )

p1
p2
```


```{r}
# ANALIZA SEZONOWOŚCI
polish_months <- c("Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec",
                   "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień")
polish_months_short <- c("Sty", "Lut", "Mar", "Kwi", "Maj", "Cze",
                         "Lip", "Sie", "Wrz", "Paź", "Lis", "Gru")

seasonality_analysis <- df %>%
  mutate(
    month_num = month(`Order Date`),
    month = polish_months[month_num],  
    year = year(`Order Date`)
  ) %>%
  group_by(month, month_num, year) %>%
  summarise(
    monthly_sales = sum(Sales, na.rm = TRUE),
    monthly_profit = sum(Profit, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(month, month_num) %>%
  summarise(
    avg_sales = mean(monthly_sales, na.rm = TRUE),
    avg_profit = mean(monthly_profit, na.rm = TRUE),
    sd_sales = sd(monthly_sales, na.rm = TRUE),
    sd_profit = sd(monthly_profit, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    month = factor(month, levels = polish_months, ordered = TRUE),
    sales_seasonality_index = (avg_sales / mean(avg_sales, na.rm = TRUE)) * 100,
    profit_seasonality_index = (avg_profit / mean(avg_profit, na.rm = TRUE)) * 100,
    month_short = polish_months_short[month_num]
  ) %>%
  arrange(month_num)

if(nrow(seasonality_analysis) > 0) {
  

  p_season <- plot_ly(
    data = seasonality_analysis,
    x = ~month_short,
    y = ~sales_seasonality_index,
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "blue", width = 3),
    marker = list(size = 8, color = "blue"),
    hovertemplate = paste(
      "<b>Miesiąc:</b> %{x}<br>",
      "<b>Indeks:</b> %{y:.1f}<br>",
      "<b>Śr. sprzedaż:</b> %{customdata:.0f}$<extra></extra>"
    ),
    customdata = ~avg_sales
  ) %>%
    layout(
      title = "Sezonowość sprzedaży",
      xaxis = list(
        title = "Miesiąc",
        categoryorder = "array",
        categoryarray = polish_months_short
      ),
      yaxis = list(
        title = "Indeks (100 = średnia)",
        range = c(0, max(seasonality_analysis$sales_seasonality_index) * 1.2)
      ),
      shapes = list(
        list(
          type = "line", xref = "paper", x0 = 0, x1 = 1,
          yref = "y", y0 = 100, y1 = 100,
          line = list(color = "gray", width = 2, dash = "dash")
        )
      )
    )
  

  heatmap_data <- data.frame(
    month = rep(polish_months_short, 2),
    metric = rep(c("Sprzedaż", "Zysk"), each = 12),
    value = c(seasonality_analysis$sales_seasonality_index,
              seasonality_analysis$profit_seasonality_index),
    month_num = rep(1:12, 2)
  ) %>%
    arrange(month_num)
  

  z_matrix <- matrix(
    heatmap_data$value,
    nrow = 2,
    byrow = TRUE,
    dimnames = list(c("Sprzedaż", "Zysk"), polish_months_short)
  )
  
  p_heatmap <- plot_ly(
    x = polish_months_short,
    y = c("Sprzedaż", "Zysk"),
    z = z_matrix,
    type = "heatmap",
    colorscale = list(
      list(0, "red"),
      list(0.5, "yellow"),
      list(1, "green")
    ),
    text = round(z_matrix, 0),
    texttemplate = "%{text}",
    textfont = list(size = 12, color = "black"),
    hovertemplate = paste(
      "<b>Miesiąc:</b> %{x}<br>",
      "<b>Metryka:</b> %{y}<br>",
      "<b>Indeks:</b> %{z:.1f}<extra></extra>"
    ),
    colorbar = list(title = "Indeks")
  ) %>%
    layout(
      title = "Heatmap sezonowości",
      xaxis = list(title = "Miesiąc"),
      yaxis = list(title = "")
    )
  
  p_season
  p_heatmap
}

```

```{r}
# ANALIZA STRATNYCH PRODUKTÓW
loss_products <- df %>%
  filter(Profit < 0) %>%
  group_by(Category, `Sub-Category`, `Product Name`) %>%
  summarise(
    total_loss = sum(Profit, na.rm = TRUE),
    avg_discount = mean(Discount, na.rm = TRUE) * 100,
    orders = n(),
    .groups = "drop"
  ) %>%
  filter(!is.na(total_loss) & total_loss < 0) %>%
  arrange(total_loss)

if(nrow(loss_products) > 0) {
  top_losses <- head(loss_products, 10) %>%
    mutate(
      loss_abs = abs(total_loss),
      hover_txt = paste0(
        "<b>Produkt:</b> ", `Product Name`,
        "<br><b>Kategoria:</b> ", Category,
        "<br><b>Podkategoria:</b> ", `Sub-Category`,
        "<br><b>Strata:</b> ", round(loss_abs, 0), "$",
        "<br><b>Śr. rabat:</b> ", round(avg_discount, 1), "%",
        "<br><b>Zamówienia:</b> ", orders
      )
    )
  
  loss_subcategories <- loss_products %>%
    group_by(Category, `Sub-Category`) %>%
    summarise(
      total_loss = sum(total_loss, na.rm = TRUE),
      avg_discount = mean(avg_discount, na.rm = TRUE),
      products = n(),
      .groups = "drop"
    ) %>%
    filter(total_loss < 0) %>%
    arrange(total_loss)
  

  p_loss_scatter <- plot_ly(
    data = top_losses,
    x = ~avg_discount,
    y = ~loss_abs,
    type = "scatter",
    mode = "markers+text",
    marker = list(
      size = ~sqrt(loss_abs / max(loss_abs)) * 60,
      color = "red",
      line = list(color = "darkred", width = 2),
      opacity = 0.7
    ),
    text = ~paste0("#", 1:nrow(top_losses)),
    textposition = "top center",
    textfont = list(size = 10, color = "black"),
    hovertext = ~hover_txt,
    hoverinfo = "text"
  ) %>%
    layout(
      title = "Produkty ze stratami: strata vs rabat",
      xaxis = list(title = "Średni rabat (%)"),
      yaxis = list(title = "Wartość strat ($)"),
      showlegend = FALSE
    )
  

  top_n <- min(8, nrow(loss_subcategories))
  top_subcats <- head(loss_subcategories, top_n) %>%
    mutate(
      loss_abs = abs(total_loss),
      hover_txt = paste0(
        "<b>Kategoria:</b> ", Category,
        "<br><b>Podkategoria:</b> ", `Sub-Category`,
        "<br><b>Strata:</b> ", round(loss_abs, 0), "$",
        "<br><b>Śr. rabat:</b> ", round(avg_discount, 1), "%",
        "<br><b>Produktów:</b> ", products
      )
    )
  

  annotations_list <- lapply(1:nrow(top_subcats), function(i) {
    list(
      x = top_subcats$`Sub-Category`[i],
      y = top_subcats$loss_abs[i],
      text = paste0(round(top_subcats$loss_abs[i]), "$"),
      xref = "x",
      yref = "y",
      showarrow = FALSE,
      xanchor = "center",
      yanchor = "bottom",
      yshift = 10,
      font = list(size = 10, color = "black")
    )
  })
  
  p_loss_subcat <- plot_ly(
    data = top_subcats,
    x = ~`Sub-Category`,
    y = ~loss_abs,
    type = "scatter",
    mode = "markers",
    marker = list(
      size = 20,
      color = "red",
      line = list(color = "darkred", width = 2)
    ),
    hovertext = ~hover_txt,
    hoverinfo = "text"
  ) %>%
    add_segments(
      x = ~`Sub-Category`,
      xend = ~`Sub-Category`,
      y = 0,
      yend = ~loss_abs,
      line = list(color = "gray", width = 3),
      showlegend = FALSE,
      hoverinfo = "skip"
    ) %>%
    layout(
      title = "Top podkategorie ze stratami",
      xaxis = list(
        title = "",
        tickangle = -45
      ),
      yaxis = list(
        title = "Wartość strat ($)",
        range = c(0, max(top_subcats$loss_abs) * 1.15)
      ),
      showlegend = FALSE,
      annotations = annotations_list
    )
  
  p_loss_scatter
  p_loss_subcat
}
```




# 4. Analiza opisowa

Analiza opisowa pozwala zrozumieć podstawowe cechy zbioru danych za
pomocą miar statystycznych, takich jak średnia, mediana czy odchylenie
standardowe. W tym rozdziale przedstawiono szczegółowe statystyki dla
wybranych zmiennych, co stanowi podstawę do dalszej analizy.

Rozkład sprzedaży charakteryzuje się silną asymetrią prawostronną – aż
60% transakcji (ok. 6 tys.) generuje sprzedaż w najniższym przedziale
(0-100 USD). W związku z tym, klasyczny podział na równe przedziały
byłby nieefektywny. Zastosowanie algorytmu Natural Breaks (Jenks)
pozwoliło na optymalne wyznaczenie granic klas, co potwierdza wysoka
wartość wskaźnika TAI.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Przygotowanie przedziałów dla Sales
etykiety <- c("0-100", "100-500", "500-1000", "1000-5000", "5000+")
limity <- cut(dane$Sales, 
              breaks = c(0, 100, 500, 1000, 5000, max(dane$Sales)), 
              labels = etykiety)

# Tabela częstości
tabela_sales <- freq(limity)


```

NIE WYCHODZI MI TAI TEST

```{r, echo=FALSE, message=FALSE, warning=FALSE}
kbl(tabela_sales, caption = "Tabela 1. Rozkład sprzedaży w Superstore (USD)") %>%
  kable_material(c("striped", "hover"))

# Test TAI metodą Jenksa
tab1_tai <- classIntervals(dane$Sales, n = 5, style = "fixed",
                           fixedBreaks = c(0, 100, 500, 1000, 5000, max(dane$Sales)))
tai_wynik <- jenks.tests(tab1_tai)

x <- dane$Sales
x <- x[is.finite(x)]

ci <- classIntervals(x, n = 5, style = "jenks")
br <- ci$brks

# GVF (Goodness of Variance Fit): im bliżej 1, tym lepiej
sdam <- sum((x - mean(x))^2)

sdcm <- sum(sapply(1:5, function(i) {
  xi <- x[x >= br[i] & x <= br[i + 1]]
  if (length(xi) <= 1) return(0)
  sum((xi - mean(xi))^2)
}))

gvf <- (sdam - sdcm) / sdam
gvf

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}


# 1. Obliczamy statystyki
desc_stats <- describe(dane[, c("Sales", "Profit", "Discount", "Quantity")])

# 2. Tworzymy tabelę, ignorując błędy konwersji i RĘCZNIE dodając nazwy
stats_df <- as.data.frame(as.matrix(desc_stats)) %>%
  select( mean, sd, median, min, max, skew, kurtosis)

# 3. Dodajemy kolumnę z nazwami na sztywno
stats_df <- cbind(Zmienna = c("Sales", "Profit", "Discount", "Quantity"), stats_df)

# 4. Wyświetlamy tabelę
stats_df %>%
  kbl(digits = 2, 
      row.names = FALSE,  # To wyłączy te brzydkie numery typu 10331
      caption = "Tabela 2. Charakterystyka statystyczna kluczowych zmiennych",
      col.names = c("Zmienna", "Średnia", "Odch. std.", "Mediana", "Min", "Max", "Skośność", "Kurtoza")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = F, position = "center") %>%
  column_spec(1, bold = T, color = "white", background = "#2c3e50") %>%
  row_spec(0, background = "#2c3e50", color = "white", bold = T)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Grupowanie i analiza rentowności
cat_profitability <- dane %>%
  group_by(Category) %>%
  summarise(
    Transakcje = n(),
    `Śr. Sprzedaż` = mean(Sales),
    `Śr. Zysk` = mean(Profit),
    `Śr. Rabat` = mean(Discount),
    `Łączny Zysk` = sum(Profit)
  )

# Tabela z heatmapą kolorystyczną dla zysku
cat_profitability %>%
  kbl(digits = 2, caption = "Tabela 2. Porównanie efektywności w segmentach produktowych") %>%
  kable_paper("striped", full_width = F) %>%
  column_spec(4, bold = T, color = "white", 
              background = spec_color(cat_profitability$`Śr. Zysk`, option = "D")) %>%
  column_spec(6, bold = T, color = "black", background = "#f9f9f9") %>%
  add_header_above(c(" " = 2, "Miary średnie" = 3, "Wynik końcowy" = 1))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Statystyki zysku wg kategorii
profit_by_cat <- dane %>%
  group_by(Category) %>%
  summarise(
    N = n(),
    `Średni Zysk` = mean(Profit),
    Mediana = median(Profit),
    `Odch. std.` = sd(Profit),
    `Suma Zysku` = sum(Profit)
  )

kbl(profit_by_cat, digits = 2, caption = "Tabela 2. Porównanie rentowności kategorii produktów") %>%
  kable_paper("striped", full_width = F) %>%
  column_spec(2, color = "white", background = "#34495e") %>%
  column_spec(6, bold = T, color = "white", 
              background = spec_color(profit_by_cat$`Suma Zysku`, option = "D"))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}


# 1. Przygotowanie danych z podziałem na Kategorię i Region
reg_cat_summary <- dane %>% 
  group_by(Category, Region) %>%
  summarise(
    N = n(),
    Srednia = mean(Profit),
    Mediana = median(Profit),
    `Suma Zysku` = sum(Profit),
    Skośność = skew(Profit),
    .groups = "drop"
  )

# 2. Generowanie tabeli
reg_cat_summary %>%
  select(-Category) %>% # Usuwamy kolumnę Category, bo zrobimy z niej nagłówki sekcji
  kbl(digits = 2, 
      caption = "Tabela 3. Analiza zysku w podziale na Kategorie i Regiony",
      col.names = c("Region", "N", "Średnia", "Mediana", "Suma Zysku", "Skośność")) %>%
  kable_paper("striped", full_width = F) %>%
  # Dodajemy kolorowanie dla Sumy Zysku (kolumna 5 w tabeli po usunięciu Category)
  column_spec(5, bold = T, color = "white", 
              background = spec_color(reg_cat_summary$`Suma Zysku`, option = "D")) %>%
  # Grupowanie wierszy według Kategorii
  pack_rows("Furniture", 1, 4) %>%
  pack_rows("Office Supplies", 5, 8) %>%
  pack_rows("Technology", 9, 12) %>%
  # Estetyka nagłówka
  row_spec(0, background = "#2c3e50", color = "white", bold = T)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}



ggplot(dane, aes(x = Profit, y = Region, fill = Region)) +
  geom_density_ridges(alpha = 0.6, scale = 1.5) +
  scale_x_continuous(limits = c(-200, 500)) + # Skupiamy się na "ciekawym" przedziale
  theme_ridges() + 
  theme(legend.position = "none") +
  labs(title = "Rozkład zysku w podziale na Regiony",
     
       x = "Zysk ($)", y = "Region")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
summary_stats <- dane %>%
  summarise(
    Srednia_Sprzedaż = mean(Sales, na.rm = TRUE),
    Mediana_Sprzedaż = median(Sales, na.rm = TRUE),
    SD_Sprzedaż = sd(Sales, na.rm = TRUE),
    Srednia_Zysk = mean(Profit, na.rm = TRUE),
    Mediana_Zysk = median(Profit, na.rm = TRUE),
    SD_Zysk = sd(Profit, na.rm = TRUE),
    Liczba_Transakcji = n()
  )
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Statystyki zysku wg regionu
profit_by_region <- dane %>%
  group_by(Region) %>%
  summarise(
    N = n(),
    `Średni Zysk` = mean(Profit),
    Mediana = median(Profit),
    `Odch. std.` = sd(Profit),
    `Suma Zysku` = sum(Profit)
  )
kbl(profit_by_region, digits = 2, caption = "Tabela 3. Porównanie rentowności wg regionów") %>%
  kable_paper("striped", full_width = F) %>%
  column_spec(2, color = "white", background = "#34495e") %>%
  column_spec(6, bold = T, color = "white", 
              background = spec_color(profit_by_region$`Suma Zysku`, option = "D"))

```

Wstępna analiza opisowa danych "Superstore" ujawniła kilka kluczowych
spostrzeżeń: - **Sprzedaż i zysk:** Średnia sprzedaż na transakcję
wynosiła około 230 USD, podczas gdy średni zysk to około 28 USD.
Jednakże rozkład zysków jest silnie skośny, z wieloma transakcjami
generującymi straty. - **Kategorie produktów:** Elektronika i meble
generowały najwyższą sprzedaż, ale to artykuły biurowe miały najwyższą
marżę zysku. - **Regiony:** Region Zachodni miał najwyższą sprzedaż, ale
również największą liczbę transakcji przynoszących straty.

Te wstępne obserwacje stanowią podstawę do dalszych analiz
statystycznych i modelowania, które pozwolą lepiej zrozumieć czynniki
wpływające na wyniki sprzedażowe i finansowe sieci sklepów.

# 5. Wnioskowanie statystyczne

W niniejszym rozdziale zweryfikowano hipotezy badawcze dotyczące
kluczowych wyników sprzedażowych i finansowych. Celem analizy jest
sprawdzenie, czy zależności zauważone w danych (np. wpływ rabatów na
zysk czy różnice między regionami) są istotne statystycznie, czy
wynikają jedynie z przypadku. W procesie badawczym wykorzystano testy
statystyczne dobrane do rodzaju danych (ilościowych i jakościowych). Dla
wszystkich testów przyjęto poziom istotności $\alpha = 0,05$. Wynik
$p < 0,05$ uznawano za dowód na istnienie statystycznie istotnej
zależności.

## 5.1. Korelacja Pearsona

Poniższa analiza sprawdza wpływ polityki rabatowej na rentowność
sprzedaży.

**H0:** Nie istnieje statystycznie istotna zależność między wysokością
rabatu a zyskiem.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
 test_kor <- cor.test(dane$Discount, dane$Profit, method = "pearson")

#wykres regresji
ggscatterstats(
  data = dane, ## data frame from which variables are taken
  x = "Discount",  
  y = "Profit", 
  xlab = "Rabat", 
  ylab = "Zysk ($)", 
  
  ggtheme = theme_classic() + theme(
    panel.grid = element_blank(),      # Usuwa siatkę
    
    axis.ticks = element_blank()       # Usuwa te małe kreski przy osiach
  ),
  
  # Opcje wizualne
  point.args = list(alpha = 0.6, size = 3, color = "grey40"),
  xfill = "#CC79A7", 
  yfill = "#009E73"
)

```

Analiza korelacji r-Pearsona wykazała istnienie statystycznie istotnej,
ujemnej zależności pomiędzy wysokością udzielonego rabatu a generowanym
zyskiem. Oznacza to, że zwiększanie poziomu rabatów wiąże się ze
spadkiem zysku ze sprzedaży. Choć siła tego związku jest słaba
($r = -0.22$), wynik jest wysoce istotny statystycznie ze względu na
dużą liczebność próby, co potwierdza negatywny wpływ obecnej polityki
rabatowej na marżowość. Choć rabaty mają na celu stymulowanie sprzedaży,
dane pokazują, że przekroczenie progu 20-30% rabatu w większości
przypadków prowadzi do nieodwracalnej utraty rentowności transakcji.

## 5.2. Regresja liniowa: wpływ rabatu na zysk

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Model regresji

model_discount <- lm(Profit ~ Discount, data = dane)
summary(model_discount)


# Poprawiony wykres regresji
ggplot(dane, aes(x = Discount, y = Profit)) +
  stat_bin2d(bins = 30) +
  scale_fill_gradient(low = "lightblue", high = "red") +
  geom_smooth(method = "lm", color = "white", se = TRUE) +
  labs(
    title = "Gęstość relacji: Rabat vs Zysk",
    x = "Rabat",
    y = "Zysk ($)",
    fill = "Liczba transakcji"
  ) +
  theme_minimal()
```

## 5.1. Test ANOVA - Czy średni zysk różni się między kategoriami produktów?


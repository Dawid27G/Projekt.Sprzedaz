"0","# ANALIZA STRATNYCH PRODUKTÓW"
"0","loss_products <- df %>%"
"0","  filter(Profit < 0) %>%"
"0","  group_by(Category, `Sub-Category`, `Product Name`) %>%"
"0","  summarise("
"0","    total_loss = sum(Profit, na.rm = TRUE),"
"0","    avg_discount = mean(Discount, na.rm = TRUE) * 100,"
"0","    orders = n(),"
"0","    .groups = ""drop"""
"0","  ) %>%"
"0","  filter(!is.na(total_loss) & total_loss < 0) %>%"
"0","  arrange(total_loss)"
"0",""
"0","if(nrow(loss_products) > 0) {"
"0","  top_losses <- head(loss_products, 10)"
"0","  loss_subcategories <- loss_products %>%"
"0","    group_by(Category, `Sub-Category`) %>%"
"0","    summarise("
"0","      total_loss = sum(total_loss, na.rm = TRUE),"
"0","      avg_discount = mean(avg_discount, na.rm = TRUE),"
"0","      products = n(),"
"0","      .groups = ""drop"""
"0","    ) %>%"
"0","    filter(total_loss < 0) %>%"
"0","    arrange(total_loss)"
"0","  "
"0","  #  Top produkty ze stratami"
"0","  par(mfrow = c(1, 2))"
"0","  # strata vs rabat"
"0","  plot(abs(top_losses$total_loss) ~ top_losses$avg_discount,"
"0","       pch = 21, "
"0","       bg = ""red"", "
"0","       cex = sqrt(abs(top_losses$total_loss) / max(abs(top_losses$total_loss))) * 3,"
"0","       main = ""Produkty ze stratami: strata vs rabat"","
"0","       xlab = ""Średni rabat (%)"","
"0","       ylab = ""Wartość strat ($)"")"
"0","  text(top_losses$avg_discount, abs(top_losses$total_loss),"
"0","       labels = 1:nrow(top_losses), "
"0","       pos = 3, "
"0","       cex = 0.7)"
"0","  grid()"
"0","  legend_size <- c(100, 500, 1000)"
"0","  legend(""topright"", "
"0","         legend = paste(""$"", legend_size),"
"0","         pt.cex = sqrt(legend_size / max(abs(top_losses$total_loss))) * 3,"
"0","         pch = 21, "
"0","         pt.bg = ""red"","
"0","         title = ""Wartość strat"","
"0","         cex = 0.8)"
"0","  #  Podkategorie ze stratami "
"0","  top_n <- min(8, nrow(loss_subcategories))"
"0","  top_subcats <- head(loss_subcategories, top_n)"
"0","  x_pos <- 1:top_n"
"0","  y_vals <- abs(top_subcats$total_loss)"
"0","  "
"0","  plot(x_pos, y_vals,"
"0","       type = ""n"","
"0","       main = ""Top podkategorie ze stratami"","
"0","       xlab = """","
"0","       ylab = ""Wartość strat ($)"","
"0","       xaxt = ""n"","
"0","       ylim = c(0, max(y_vals) * 1.1))"
"0","  segments(x_pos, 0, x_pos, y_vals, "
"0","           col = ""gray"", "
"0","           lwd = 2)"
"0","  points(x_pos, y_vals, "
"0","         pch = 21, "
"0","         bg = ""red"", "
"0","         cex = 3,"
"0","         col = ""darkred"")"
"0","  text(x_pos, y_vals, "
"0","       labels = paste0(""$"", round(y_vals)),"
"0","       pos = 3, "
"0","       cex = 0.7)"
"0","  axis(1, at = x_pos, labels = top_subcats$`Sub-Category`, las = 2, cex.axis = 0.8)"
"0","  "
"0","  grid()"
"0","}"

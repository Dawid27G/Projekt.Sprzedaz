"0","dane <- dane %>%"
"0","  mutate("
"0","    `Order Date` = as.Date(`Order Date`),"
"0","    `Ship Date`  = as.Date(`Ship Date`)"
"0","  )"
"0",""
"0",""
"0","hotdeck_grouped <- function(x, group_df) {"
"0","  out <- x"
"0","  g <- interaction(group_df, drop = TRUE)"
"0",""
"0","  for (lv in levels(g)) {"
"0","    idx <- which(g == lv)"
"0","    vals <- x[idx]"
"0","    miss <- is.na(vals)"
"0",""
"0","    if (any(miss) && any(!miss)) {"
"0","      out[idx][miss] <- sample(vals[!miss], sum(miss), replace = TRUE)"
"0","    }"
"0","  }"
"0",""
"0",""
"0","  if (any(is.na(out)) && any(!is.na(out))) {"
"0","    out[is.na(out)] <- sample(out[!is.na(out)], sum(is.na(out)), replace = TRUE)"
"0","  }"
"0",""
"0","  out"
"0","}"
"0",""
"0","cat_vars <- c(""Ship Mode"",""Segment"",""Region"",""Category"",""Sub-Category"")"
"0","cat_vars <- intersect(cat_vars, names(dane))"
"0",""
"0","group_vars <- c(""Region"",""Segment"")"
"0","group_vars <- intersect(group_vars, names(dane))"
"0",""
"0","set.seed(123)"
"0","for (v in cat_vars) {"
"0","  dane[[v]] <- hotdeck_grouped(dane[[v]], dane[group_vars])"
"0","}"
"0",""
"0",""
"0","num_vars <- c(""Sales"",""Quantity"",""Discount"",""Profit"")"
"0","num_vars <- intersect(num_vars, names(dane))"
"0",""
"0","num_df <- dane %>% select(all_of(num_vars))"
"0",""
"0","set.seed(123)"
"0","imp_num <- mice("
"0","  num_df,"
"0","  m = 5,"
"0","  method = ""pmm"","
"0","  maxit = 5,"
"0","  printFlag = FALSE"
"0",")"
"0",""
"0","num_complete <- complete(imp_num, 1)"
"0",""
"0",""
"0","dane[num_vars] <- num_complete"
"0",""
"0",""
"0","if (all(c(""Product ID"", ""Product Name"") %in% names(dane))) {"
"0","  lookup_prod <- dane %>%"
"0","    filter(!is.na(`Product ID`), !is.na(`Product Name`)) %>%"
"0","    distinct(`Product ID`, `Product Name`)"
"0",""
"0","  dane <- dane %>%"
"0","    left_join(lookup_prod, by = ""Product ID"", suffix = c("""", "".from_id"")) %>%"
"0","    mutate(`Product Name` = ifelse(is.na(`Product Name`), `Product Name.from_id`, `Product Name`)) %>%"
"0","    select(-`Product Name.from_id`)"
"0","}"
"0",""
"0",""
"0","fill_by_key_first <- function(x, key) {"
"0",""
"0","  filled <- ave(x, key, FUN = function(z) {"
"0","    if (all(is.na(z))) return(z)"
"0","    z[is.na(z)] <- z[which(!is.na(z))[1]]"
"0","    z"
"0","  })"
"0","  filled"
"0","}"
"0",""
"0","if (""Postal Code"" %in% names(dane)) {"
"0","  if (""City"" %in% names(dane))  dane$City  <- fill_by_key_first(dane$City,  dane$`Postal Code`)"
"0","  if (""State"" %in% names(dane)) dane$State <- fill_by_key_first(dane$State, dane$`Postal Code`)"
"0","}"
"0",""
"0",""
"0","if (""City"" %in% names(dane) && ""State"" %in% names(dane)) {"
"0","  dane$City <- fill_by_key_first(dane$City, dane$State)"
"0","}"
"0","if (""State"" %in% names(dane) && ""Region"" %in% names(dane)) {"
"0","  dane$State <- fill_by_key_first(dane$State, dane$Region)"
"0","}"
"0",""
"0","if (all(c(""Order Date"",""Ship Date"",""Ship Mode"",""Region"") %in% names(dane))) {"
"0","  ship_days <- as.integer(dane$`Ship Date` - dane$`Order Date`)"
"0",""
"0","  grp <- interaction(dane$`Ship Mode`, dane$Region, drop = TRUE)"
"0","  med_by_grp <- tapply(ship_days, grp, function(z) median(z, na.rm = TRUE))"
"0",""
"0","  miss_sd <- is.na(dane$`Ship Date`)"
"0","  if (any(miss_sd)) {"
"0",""
"0","    global_med <- median(ship_days, na.rm = TRUE)"
"0","    fill_days <- med_by_grp[as.character(grp[miss_sd])]"
"0","    fill_days[is.na(fill_days)] <- global_med"
"0",""
"0","    dane$`Ship Date`[miss_sd] <- dane$`Order Date`[miss_sd] + as.integer(fill_days)"
"0","  }"
"0","}"
"0",""
"0","for (nm in names(dane)) {"
"0","  if (anyNA(dane[[nm]])) {"
"0","    if (is.numeric(dane[[nm]])) {"
"0","      dane[[nm]][is.na(dane[[nm]])] <- median(dane[[nm]], na.rm = TRUE)"
"0","    } else if (inherits(dane[[nm]], ""Date"")) {"
"0","      dane[[nm]][is.na(dane[[nm]])] <- median(dane[[nm]], na.rm = TRUE)"
"0","    } else {"
"0",""
"0","      tab <- table(dane[[nm]])"
"0","      moda <- names(tab)[which.max(tab)]"
"0","      dane[[nm]][is.na(dane[[nm]])] <- moda"
"0","    }"
"0","  }"
"0","}"
"0",""
"0",""
"0","stopifnot(sum(is.na(dane)) == 0)"
"0",""
"0","md.pattern(dane)"
"1"," /\     /\
{  `---'  }
{  O   O  }
==>  V <=="
"1","  No need for mice. This data set is completely observed.
"
"1"," \  \|/  /
  `-----'

"
"1","     "
"1"," Row ID"
"1"," Order ID"
"1"," Order Date"
"1"," Ship Date"
"1"," Ship Mode"
"1"," Customer ID"
"1"," Customer Name"
"1","
10331"
"1","      1"
"1","        1"
"1","          1"
"1","         1"
"1","         1"
"1","           1"
"1","             1"
"1","
     "
"1","      0"
"1","        0"
"1","          0"
"1","         0"
"1","         0"
"1","           0"
"1","             0"
"1","
"
"1","     "
"1"," Segment"
"1"," Country"
"1"," City"
"1"," State"
"1"," Postal Code"
"1"," Region"
"1"," Product ID"
"1"," Category"
"1"," Sub-Category"
"1","
10331"
"1","       1"
"1","       1"
"1","    1"
"1","     1"
"1","           1"
"1","      1"
"1","          1"
"1","        1"
"1","            1"
"1","
     "
"1","       0"
"1","       0"
"1","    0"
"1","     0"
"1","           0"
"1","      0"
"1","          0"
"1","        0"
"1","            0"
"1","
"
"1","     "
"1"," Product Name"
"1"," Sales"
"1"," Quantity"
"1"," Discount"
"1"," Profit"
"1","  "
"1","
10331"
"1","            1"
"1","     1"
"1","        1"
"1","        1"
"1","      1"
"1"," 0"
"1","
     "
"1","            0"
"1","     0"
"1","        0"
"1","        0"
"1","      0"
"1"," 0"
"1","
"
